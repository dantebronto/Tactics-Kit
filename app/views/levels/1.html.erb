<% content_for :head_scripts do %>
  <script type="text/javascript">
    // getjson the level code
    // on callback
    // create new level w/ terrain map
    // fade in the stage
    // getjson party by user id, possibly include inventory
    // getjson enemies by level or from level
    // getting from level is better idea
    // 
    var init_level = function(){
      var map = new Map([ 
        [ 15, 15, 15, 15, 15, 15, 15, 15 ], 
        [ 15, 15, 15, 15, 15, 15, 15, 15 ],
        [ 15, 15, 15, 15, 15, 15, 15, 15 ], 
        [ 15, 15, 15, 10, 10, 15, 15, 15 ], 
        [ 15, 15, 10, 10, 10, 10, 15, 15 ],
        [ 15, 15, 10, 10, 10, 10, 15, 15 ],
        [ 15, 15, 10, 10, 10, 10, 15, 15 ],
        [ 15, 15, 10, 10, 10, 10, 15, 15 ],
        [ 15, 15, 10, 10, 10, 10, 15, 15 ],
        [ 15, 15, 10, 10, 10, 10, 15, 15 ],
        [ 15, 15, 10, 10, 10, 10, 15, 15 ],
        [ 15, 15, 10, 10, 10, 10, 15, 15 ],
        [ 15, 15, 10, 10, 10, 10, 15, 15 ],
        [ 15, 15, 10, 10, 10, 10, 15, 15 ],
        [ 15, 15, 10, 10, 10, 10, 15, 15 ],
        [ 15, 15, 15, 15, 15, 15, 15, 15 ]
      ]);

      window['level'] = new Level({ map: map });

      $('#stage').hide().fadeIn(2000, function(){ 
        level.info_div.hide().fadeIn(500); 

        var inventory = new Inventory([
          ['Potion', 3]
        ]);
        
        $.getJSON(view('character/by_name'), function(r){  
          
          run_func_from_doc(view('level/by_number', '?key=<%= params[:id] %>'), 'setup');
          
          var json = $.extend({ name: 'Atom', map: level.map, x: 3, y: 3 }, r['rows'][0]['value']);
          
          var hero = new Character(json);
          
          level.active_player = hero;
          
          var girl = new Character({ 
            map: level.map, x: 4, y: 3,
            name: 'Claudia', 
            sprite: '/images/girl.gif',
            inventory: inventory, 
            weapon: new Weapon({ range: 3, attack: 1,  is_ranged: true, dead_range: 1, name: 'Weak Ass Bow' })
          });
          
          level.players = [hero, girl];

          var foo = new Enemy( { map: level.map } );
          var bar = new Enemy( { map: level.map, x: 4, y: 14 } );
          level.enemies = [foo, bar];
          
          level.assign_ids();
          level.reset_turn();
        });
      
      });
    }
  </script>
<% end %>