<% content_for :head_scripts do -%>
<script type="text/javascript">
  $(document).ready(function(){
    var map = new Map([ 
      [ 15, 15, 15, 15, 15, 15, 15, 15 ], 
      [ 15, 15, 15, 15, 15, 15, 15, 15 ],
      [ 15, 15, 15, 15, 15, 15, 15, 15 ], 
      [ 15, 15, 15, 10, 10, 15, 15, 15 ], 
      [ 15, 15, 10, 10, 10, 10, 15, 15 ],
      [ 15, 15, 10, 10, 10, 10, 15, 15 ],
      [ 15, 15, 10, 15, 10, 10, 15, 15 ],
      [ 15, 15, 10, 10, 10, 10, 15, 15 ],
      [ 15, 15, 10, 10, 10, 10, 15, 15 ],
      [ 15, 15, 10, 10, 10, 10, 15, 15 ],
      [ 15, 15, 10, 10, 10, 10, 15, 15 ],
      [ 15, 15, 10, 10, 10, 10, 15, 15 ],
      [ 15, 15, 10, 10, 10, 10, 15, 15 ],
      [ 15, 15, 10, 10, 10, 10, 15, 15 ],
      [ 15, 15, 10, 10, 10, 10, 15, 15 ],
      [ 15, 15, 15, 15, 15, 15, 15, 15 ]
    ]);

    window['level'] = new Level({ map: map });
    
    $('#map').
      css('width', '410px').
      css('height', '816px').
      css('background-image', 'url(/images/test_map.jpg)');
    
    level.turn_function = function(){
      console.log(this.turn);
      if ( this.turn == 8 ){
        
        alert('Reinforcements are boarding!');
        
        if ( level.map.enemy_matrix.e(3, 14).hasClass('occupied') != true &&
            level.map.player_matrix.e(3, 14).hasClass('occupied') != true ){  
            var baz = new Enemy( { map: level.map, x: 3, y: 14, name: 'Baz' } );
            level.enemies.push(baz);
            level.higest_id += 1;
            baz.level_id = level.higest_id;              
        }
        
        if ( level.map.enemy_matrix.e(4, 14).hasClass('occupied') != true &&
            level.map.player_matrix.e(4, 14).hasClass('occupied') != true ){  
            var bat = new Enemy( { map: level.map, x: 4, y: 14, name: 'Bat' } );
            level.enemies.push(bat);
            level.higest_id += 1;
            bat.level_id = level.higest_id;              
        }
      }
    };
    
    level.end_function = function(){};
    
    $('#stage').hide().fadeIn(2000, function(){ 
      
      var key = 'startkey=["' + PLAYER_ID + '"]&endkey=["' + PLAYER_ID + '",{}]';
      $.getJSON(view('character/party_with_inventory', key), function(res){
        var rows = res['rows'];
        
        if ( rows.length == 0 ){ // create party and inventory if it doesn't exist
          rows.push({ value: [['Potion', 3]] });
          rows.push({ value: { sprite: '/images/bar.gif' } });
          rows.push({ 
            value: 
            { 
              sprite: '/images/girl.gif', 
              name: 'Claudia', 
              weapon: new Weapon({ range: 3, attack: 1, is_ranged: true, dead_range: 1, name: 'Weak Bow' }),
              hp: 45
            } 
          });
        }
        
        var inventory = new Inventory(rows.reverse().pop().value);
        
        // instantiate players
        var player, json, pos;
        
        level.players = [];
        
        var positions = [ [3,3], [4,3] ];
        
        while( rows.length > 0 ){
          pos = positions.reverse().pop();
          json = $.extend({ 
            map: level.map, 
            x : pos[0], 
            y : pos[1] 
          }, rows.reverse().pop().value);
          
          player = new Character(json);
          player.inventory = inventory;
          level.players.push(player);
        }
        
        level.active_player = level.players[0];
        
        // instantiate enemies
        var foo = new Enemy( { map: level.map, name: 'Foo', sprite: '/images/penguin2.gif' } );
        var bar = new Enemy( { map: level.map, x: 4, y: 14, name: 'Bar', sprite: '/images/turtle_man.gif' } );
        level.enemies = [foo, bar];
        
        level.assign_ids();
        level.reset_turn();
      });
    });
  });
</script>
<% end %>